# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: coverage-badges
on:
  push:
    branches:
      - dev
jobs:
  generate-coverage-badges:
    runs-on:
      - self-hosted
      - amd64
    permissions:
      contents: write
    steps:
      - name: extract branch used
        id: extract_branch
        run: echo ::set-output name=branch::${GITHUB_REF#refs/*/}
      - name: checkout source
        uses: actions/checkout@v2
        with:
          path: ./source
      - name: npm login
        env:
          NPM_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: echo "//npm.pkg.github.com/:_authToken=${NPM_TOKEN}" > ~/.npmrc
      - name: setup node
        uses: actions/setup-node@v3
        with: {}
      - name: Install dependencies
        run: npm --prefix ./source install ./source
      - name: generate coverage
        run: npm --prefix ./source run coverage
      - name: zip coverage results
        run: zip -r "./source/coverage/report.zip" "./source/coverage"
      - name: checkout wiki
        uses: actions/checkout@v2
        with:
          repository: ${{github.repository}}.wiki
          path: ./wiki
      - name: prep wiki upload directory
        run: rm -rf "coverage/${{ steps.extract_branch.outputs.branch }}" && mkdir -p "coverage/${{ steps.extract_branch.outputs.branch }}"
      - name: generate badges
        run: npx jest-coverage-badges --input ./source/coverage/coverage-summary.json --output "./wiki/coverage/${{ steps.extract_branch.outputs.branch }}/badges"
      - name: include additional files
        run: cp -a ./source/coverage/report.zip "./wiki/coverage/${{ steps.extract_branch.outputs.branch }}"
      - name: upload to wiki
        run: 'cd ./wiki && git config user.name "github-actions" && git config user.email "github-actions@github.com" && git add . && git commit -m "chore(CodeCoverage): Update coverage results" && git push origin master'
